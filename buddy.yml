- pipeline: "Staging"
  trigger_mode: "ON_EVERY_PUSH"
  ref_name: "develop"
  ref_type: "BRANCH"
  priority: "LOW"
  fetch_all_refs: true
  trigger_condition: "ALWAYS"
  actions:
    - action: "Slack started to #buddy"
      type: "SLACK"
      content: "⏳ ${BUDDY_PROJECT_NAME}: ${BUDDY_EXECUTION_BRANCH} to ${BUDDY_PIPELINE_NAME} <${BUDDY_EXECUTION_URL}|#${BUDDY_EXECUTION_ID} ${BUDDY_EXECUTION_COMMENT}> by <$BUDDY_INVOKER_URL|$BUDDY_INVOKER_NAME>"
      blocks: "[]"
      channel: "C94Q7EX0C"
      channel_name: "buddy"
      trigger_condition: "ALWAYS"
      integration_hash: "5dde343c422f5a6e5bb6c666"
    - action: "Oh Dear Maintenance period start"
      type: "HTTP"
      notification_url: "https://ohdear.app/api/sites/${OHDEAR_SITE_ID}/start-maintenance"
      method: "POST"
      headers:
        - name: "Accept"
          value: "application/json"
        - name: "Content-Type"
          value: "application/json"
        - name: "Authorization"
          value: "Bearer ${OHDEAR_TOKEN}"
    - action: "Build static assets"
      type: "BUILD"
      working_directory: "/buddy/${APPNAME}"
      docker_image_name: "library/node"
      docker_image_tag: "16.20.0"
      execute_commands:
        - "npm install"
        - "npm build"
      volume_mappings:
        - "/:/buddy/${APPNAME}"
      trigger_condition: "ON_CHANGE_AT_PATH"
      trigger_condition_paths:
        - "/buddy.yml"
        - "/postcss.config.js"
        - "/tailwind.config.js"
        - "/vue.config.js"
        - "/package-lock.json"
        - "/src/"
        - "/templates/"
      shell: "BASH"
    - action: "Rsync to server"
      type: "RSYNC"
      remote_path: "$REMOTE_PATH"
      login: "$LOGIN"
      host: "$SERVER_IP"
      port: "22"
      authentication_mode: "WORKSPACE_KEY"
      arguments: "--omit-dir-times --no-perms"
      archive: true
      delete_extra_files: true
      recursive: true
      compress: true
      deployment_excludes:
        - "/.env"
        - "/.git/"
        - "/.gitpod.yml"
        - "/.gitpod/"
        - "/buddy.yml"
        - "/swiff.config.js"
        - "/node_modules/"
        - "/src/"
        - "/storage/composer-backups"
        - "/storage/config-deltas"
        - "/storage/logs"
        - "/storage/runtime"
        - "/storage/rebrand/"
        - "/storage/backups/"
        - "/vendor/"
        - "/web/assets"
        - "/web/cpresources"
        - "/web/uploads"
      trigger_condition: "ON_CHANGE_AT_PATH"
      trigger_condition_paths:
        - "/.env"
        - "/buddy.yml"
        - "/composer.json"
        - "/composer.lock"
        - "/craft"
        - "/postcss.config.js"
        - "/tailwind.config.js"
        - "/vue.config.js"
        - "/package-lock.json"
        - "/config/"
        - "/modules/"
        - "/plugins/"
        - "/src/"
        - "/storage/rebrand"
        - "/templates/"
        - "/web/"
    - action: "Composer Install"
      type: "SSH_COMMAND"
      working_directory: "$REMOTE_PATH"
      login: "$LOGIN"
      host: "$SERVER_IP"
      port: "22"
      env_key: "secure!tCK8j7TiFx7LuSs3dJ3qQwJwzNP6zbjJhEDn1pKgQY0=.l1tu1XRRCu89cZcU9X1IVA=="
      authentication_mode: "WORKSPACE_KEY"
      commands:
        - "composer install"
        - "php craft backup/db"
        - "php craft migrate/all"
      trigger_condition: "ON_CHANGE_AT_PATH"
      trigger_condition_paths:
        - "/buddy.yml"
        - "/composer.json"
        - "/composer.lock"
      run_as_script: true
      shell: "BASH"
    # - action: "Set storage permissions"
    #   type: "SSH_COMMAND"
    #   working_directory: "$REMOTE_PATH"
    #   login: "$LOGIN"
    #   host: "$SERVER_IP"
    #   port: "22"
    #   env_key: "secure!tCK8j7TiFx7LuSs3dJ3qQwJwzNP6zbjJhEDn1pKgQY0=.l1tu1XRRCu89cZcU9X1IVA=="
    #   authentication_mode: "WORKSPACE_KEY"
    #   commands:
    #   - "chmod -R 777 storage"
    #   trigger_condition: "ALWAYS"
    #   run_as_script: true
    #   shell: "BASH"
    - action: "Project Config Apply"
      type: "SSH_COMMAND"
      working_directory: "$REMOTE_PATH"
      login: "$LOGIN"
      host: "$SERVER_IP"
      port: "22"
      env_key: "secure!tCK8j7TiFx7LuSs3dJ3qQwJwzNP6zbjJhEDn1pKgQY0=.l1tu1XRRCu89cZcU9X1IVA=="
      authentication_mode: "WORKSPACE_KEY"
      commands:
        - "php craft project-config/apply"
      trigger_condition: "ON_CHANGE_AT_PATH"
      trigger_condition_paths:
        - "/buddy.yml"
        - "/config/project/"
      run_as_script: true
      shell: "BASH"
    - action: "Clear Cloudflare"
      type: "SSH_COMMAND"
      working_directory: "$REMOTE_PATH"
      login: "$LOGIN"
      host: "$SERVER_IP"
      port: "22"
      env_key: "secure!tCK8j7TiFx7LuSs3dJ3qQwJwzNP6zbjJhEDn1pKgQY0=.l1tu1XRRCu89cZcU9X1IVA=="
      authentication_mode: "WORKSPACE_KEY"
      commands:
        - "php craft cloudflare/purge/purge-all"
      trigger_condition: "ON_CHANGE_AT_PATH"
      trigger_condition_paths:
        - "/buddy.yml"
        - "/composer.json"
        - "/composer.lock"
        - "/postcss.config.js"
        - "/tailwind.config.js"
        - "/vue.config.js"
        - "/package-lock.json"
        - "/config/"
        - "/src/"
        - "/templates/"
      ignore_errors: true
      run_as_script: true
      shell: "BASH"
    - action: "Oh Dear Maintenance period stop"
      type: "HTTP"
      notification_url: "https://ohdear.app/api/sites/${OHDEAR_SITE_ID}/stop-maintenance"
      method: "POST"
      headers:
        - name: "Accept"
          value: "application/json"
        - name: "Content-Type"
          value: "application/json"
        - name: "Authorization"
          value: "Bearer ${OHDEAR_TOKEN}"
    - action: "Slack completed to #buddy"
      type: "SLACK"
      content: "✅ ${BUDDY_PROJECT_NAME}: ${BUDDY_EXECUTION_BRANCH} to ${BUDDY_PIPELINE_NAME} <${BUDDY_EXECUTION_URL}|#${BUDDY_EXECUTION_ID} ${BUDDY_EXECUTION_COMMENT}> by <$BUDDY_INVOKER_URL|$BUDDY_INVOKER_NAME>"
      blocks: "[]"
      channel: "C94Q7EX0C"
      channel_name: "buddy"
      trigger_condition: "ALWAYS"
      integration_hash: "5dde343c422f5a6e5bb6c666"
    - action: "Slack failed to #buddy"
      type: "SLACK"
      trigger_time: "ON_FAILURE"
      content: "❌ ${BUDDY_PROJECT_NAME}: ${BUDDY_EXECUTION_BRANCH} to ${BUDDY_PIPELINE_NAME} <${BUDDY_EXECUTION_URL}|#${BUDDY_EXECUTION_ID} ${BUDDY_EXECUTION_COMMENT}> by <$BUDDY_INVOKER_URL|$BUDDY_INVOKER_NAME> "
      blocks: "[]"
      channel: "C94Q7EX0C"
      channel_name: "buddy"
      trigger_condition: "ALWAYS"
      integration_hash: "5dde343c422f5a6e5bb6c666"
  variables:
    - key: "REMOTE_PATH"
      value: "/home/master/applications/start/public_html/"
      settable: true
    - key: "LOGIN"
      value: "master_xxx"
      settable: true
    - key: "SERVER_IP"
      value: "123.XXX"
      settable: true
    - key: "OHDEAR_SITE_ID"
      value: ""
      settable: true
    - key: "OHDEAR_TOKEN"
      value: ""
      settable: true
